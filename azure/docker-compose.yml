# Docker Compose for Local Development
# Irado Chatbot System - Local Development Environment

version: '3.8'

services:
  # PostgreSQL Chat Database
  postgres-chat:
    image: postgres:14-alpine
    container_name: irado-postgres-chat
    environment:
      POSTGRES_DB: irado_chat
      POSTGRES_USER: irado
      POSTGRES_PASSWORD: irado123
    ports:
      - "5432:5432"
    volumes:
      - postgres_chat_data:/var/lib/postgresql/data
      - ./database_schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
    networks:
      - irado-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U irado -d irado_chat"]
      interval: 30s
      timeout: 10s
      retries: 3

  # PostgreSQL Bedrijfsklanten Database
  postgres-bedrijfsklanten:
    image: postgres:14-alpine
    container_name: irado-postgres-bedrijfsklanten
    environment:
      POSTGRES_DB: irado_bedrijfsklanten
      POSTGRES_USER: irado
      POSTGRES_PASSWORD: irado123
    ports:
      - "5433:5432"
    volumes:
      - postgres_bedrijfsklanten_data:/var/lib/postgresql/data
      - ./database_schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
    networks:
      - irado-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U irado -d irado_bedrijfsklanten"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Chatbot Service
  chatbot:
    build:
      context: ./containers/chatbot
      dockerfile: Dockerfile
    container_name: irado-chatbot
    environment:
      - FLASK_ENV=development
      - DATABASE_HOST=postgres-chat
      - DATABASE_PORT=5432
      - DATABASE_NAME=irado_chat
      - DATABASE_USER=irado
      - DATABASE_PASSWORD=irado123
      - BEDRIJFSKLANTEN_DB_HOST=postgres-bedrijfsklanten
      - BEDRIJFSKLANTEN_DB_PORT=5432
      - BEDRIJFSKLANTEN_DB_NAME=irado_bedrijfsklanten
      - BEDRIJFSKLANTEN_DB_USER=irado
      - BEDRIJFSKLANTEN_DB_PASSWORD=irado123
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPEN_POSTCODE_API_BASE_URL=https://openpostcode.nl/api
    ports:
      - "5000:5000"
    depends_on:
      postgres-chat:
        condition: service_healthy
      postgres-bedrijfsklanten:
        condition: service_healthy
    networks:
      - irado-network
    volumes:
      - ./containers/chatbot:/app
      - chatbot_logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Dashboard Service
  dashboard:
    build:
      context: ./containers/dashboard
      dockerfile: Dockerfile
    container_name: irado-dashboard
    environment:
      - FLASK_ENV=development
      - DATABASE_HOST=postgres-chat
      - DATABASE_PORT=5432
      - DATABASE_NAME=irado_chat
      - DATABASE_USER=irado
      - DATABASE_PASSWORD=irado123
      - BEDRIJFSKLANTEN_DB_HOST=postgres-bedrijfsklanten
      - BEDRIJFSKLANTEN_DB_PORT=5432
      - BEDRIJFSKLANTEN_DB_NAME=irado_bedrijfsklanten
      - BEDRIJFSKLANTEN_DB_USER=irado
      - BEDRIJFSKLANTEN_DB_PASSWORD=irado123
    ports:
      - "5001:5001"
    depends_on:
      postgres-chat:
        condition: service_healthy
      postgres-bedrijfsklanten:
        condition: service_healthy
    networks:
      - irado-network
    volumes:
      - ./containers/dashboard:/app
      - dashboard_logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Website Proxy
  website:
    build:
      context: ./containers/website
      dockerfile: Dockerfile
    container_name: irado-website
    environment:
      - NODE_ENV=development
      - CHATBOT_URL=http://chatbot:5000
      - PORT=80
    ports:
      - "3254:80"
    depends_on:
      chatbot:
        condition: service_healthy
    networks:
      - irado-network
    volumes:
      - ./containers/website:/app
      - ./website:/app/website
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Dashboard Frontend
  dashboard-frontend:
    build:
      context: ./containers/dashboard-frontend
      dockerfile: Dockerfile
    container_name: irado-dashboard-frontend
    environment:
      - NODE_ENV=development
      - DASHBOARD_URL=http://dashboard:5001
      - PORT=80
    ports:
      - "3256:80"
    depends_on:
      dashboard:
        condition: service_healthy
    networks:
      - irado-network
    volumes:
      - ./containers/dashboard-frontend:/app
      - ./dashboard:/app/dashboard
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis for Caching (Optional)
  redis:
    image: redis:7-alpine
    container_name: irado-redis
    ports:
      - "6379:6379"
    networks:
      - irado-network
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nginx Load Balancer (Optional)
  nginx:
    image: nginx:alpine
    container_name: irado-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - website
      - dashboard-frontend
    networks:
      - irado-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3

# Networks
networks:
  irado-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# Volumes
volumes:
  postgres_chat_data:
    driver: local
  postgres_bedrijfsklanten_data:
    driver: local
  chatbot_logs:
    driver: local
  dashboard_logs:
    driver: local
  redis_data:
    driver: local
